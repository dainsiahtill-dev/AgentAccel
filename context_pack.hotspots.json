{
  "version": 1,
  "task": "Refactor major HarborPilot hotspots with minimal behavior change",
  "generated_at": "2026-02-10T18:47:15.334279+00:00",
  "budget": {
    "max_chars": 24000,
    "max_snippets": 60,
    "top_n_files": 12
  },
  "top_files": [
    {
      "path": "src/frontend/src/app/components/HarborPilotTerminalRenderer.tsx",
      "score": 0.457143,
      "reasons": [
        "symbol_match",
        "reference_proximity"
      ],
      "signals": [
        {
          "signal_name": "symbol_match",
          "score": 1.0
        },
        {
          "signal_name": "reference_proximity",
          "score": 0.428571
        },
        {
          "signal_name": "dependency_impact",
          "score": 0.0
        },
        {
          "signal_name": "test_relevance",
          "score": 0.0
        },
        {
          "signal_name": "changed_boost",
          "score": 0.0
        }
      ]
    },
    {
      "path": "src/backend/app/utils.py",
      "score": 0.335714,
      "reasons": [
        "symbol_match",
        "reference_proximity",
        "test_relevance"
      ],
      "signals": [
        {
          "signal_name": "symbol_match",
          "score": 0.285714
        },
        {
          "signal_name": "reference_proximity",
          "score": 0.142857
        },
        {
          "signal_name": "dependency_impact",
          "score": 0.0
        },
        {
          "signal_name": "test_relevance",
          "score": 1.0
        },
        {
          "signal_name": "changed_boost",
          "score": 0.0
        }
      ]
    },
    {
      "path": "src/backend/core/harborpilot_loop/director_exec.py",
      "score": 0.335714,
      "reasons": [
        "symbol_match",
        "reference_proximity",
        "test_relevance"
      ],
      "signals": [
        {
          "signal_name": "symbol_match",
          "score": 0.285714
        },
        {
          "signal_name": "reference_proximity",
          "score": 0.142857
        },
        {
          "signal_name": "dependency_impact",
          "score": 0.0
        },
        {
          "signal_name": "test_relevance",
          "score": 1.0
        },
        {
          "signal_name": "changed_boost",
          "score": 0.0
        }
      ]
    },
    {
      "path": "tests/e2e/utils/file_utils.py",
      "score": 0.3,
      "reasons": [
        "symbol_match",
        "test_relevance"
      ],
      "signals": [
        {
          "signal_name": "symbol_match",
          "score": 0.285714
        },
        {
          "signal_name": "reference_proximity",
          "score": 0.0
        },
        {
          "signal_name": "dependency_impact",
          "score": 0.0
        },
        {
          "signal_name": "test_relevance",
          "score": 1.0
        },
        {
          "signal_name": "changed_boost",
          "score": 0.0
        }
      ]
    },
    {
      "path": "src/frontend/src/app/components/llm/state/ProviderContext.tsx",
      "score": 0.271429,
      "reasons": [
        "symbol_match",
        "reference_proximity"
      ],
      "signals": [
        {
          "signal_name": "symbol_match",
          "score": 0.571429
        },
        {
          "signal_name": "reference_proximity",
          "score": 0.285714
        },
        {
          "signal_name": "dependency_impact",
          "score": 0.0
        },
        {
          "signal_name": "test_relevance",
          "score": 0.0
        },
        {
          "signal_name": "changed_boost",
          "score": 0.0
        }
      ]
    },
    {
      "path": "src/frontend/src/app/components/llm/providers/AnthropicCompatProviderSettings.tsx",
      "score": 0.25,
      "reasons": [
        "reference_proximity"
      ],
      "signals": [
        {
          "signal_name": "symbol_match",
          "score": 0.0
        },
        {
          "signal_name": "reference_proximity",
          "score": 1.0
        },
        {
          "signal_name": "dependency_impact",
          "score": 0.0
        },
        {
          "signal_name": "test_relevance",
          "score": 0.0
        },
        {
          "signal_name": "changed_boost",
          "score": 0.0
        }
      ]
    },
    {
      "path": "src/frontend/src/app/components/llm/providers/CodexCLIProviderSettings.tsx",
      "score": 0.25,
      "reasons": [
        "reference_proximity"
      ],
      "signals": [
        {
          "signal_name": "symbol_match",
          "score": 0.0
        },
        {
          "signal_name": "reference_proximity",
          "score": 1.0
        },
        {
          "signal_name": "dependency_impact",
          "score": 0.0
        },
        {
          "signal_name": "test_relevance",
          "score": 0.0
        },
        {
          "signal_name": "changed_boost",
          "score": 0.0
        }
      ]
    },
    {
      "path": "src/frontend/src/app/components/llm/providers/GeminiCLIProviderSettings.tsx",
      "score": 0.25,
      "reasons": [
        "reference_proximity"
      ],
      "signals": [
        {
          "signal_name": "symbol_match",
          "score": 0.0
        },
        {
          "signal_name": "reference_proximity",
          "score": 1.0
        },
        {
          "signal_name": "dependency_impact",
          "score": 0.0
        },
        {
          "signal_name": "test_relevance",
          "score": 0.0
        },
        {
          "signal_name": "changed_boost",
          "score": 0.0
        }
      ]
    },
    {
      "path": "src/frontend/src/app/components/llm/providers/OllamaProviderSettings.tsx",
      "score": 0.25,
      "reasons": [
        "reference_proximity"
      ],
      "signals": [
        {
          "signal_name": "symbol_match",
          "score": 0.0
        },
        {
          "signal_name": "reference_proximity",
          "score": 1.0
        },
        {
          "signal_name": "dependency_impact",
          "score": 0.0
        },
        {
          "signal_name": "test_relevance",
          "score": 0.0
        },
        {
          "signal_name": "changed_boost",
          "score": 0.0
        }
      ]
    },
    {
      "path": "src/frontend/src/app/components/llm/visual/hooks/useVisualLLMConfig.ts",
      "score": 0.25,
      "reasons": [
        "reference_proximity"
      ],
      "signals": [
        {
          "signal_name": "symbol_match",
          "score": 0.0
        },
        {
          "signal_name": "reference_proximity",
          "score": 1.0
        },
        {
          "signal_name": "dependency_impact",
          "score": 0.0
        },
        {
          "signal_name": "test_relevance",
          "score": 0.0
        },
        {
          "signal_name": "changed_boost",
          "score": 0.0
        }
      ]
    },
    {
      "path": "src/frontend/src/app/components/llm/providers/CodexSDKProviderSettings.tsx",
      "score": 0.214286,
      "reasons": [
        "reference_proximity"
      ],
      "signals": [
        {
          "signal_name": "symbol_match",
          "score": 0.0
        },
        {
          "signal_name": "reference_proximity",
          "score": 0.857143
        },
        {
          "signal_name": "dependency_impact",
          "score": 0.0
        },
        {
          "signal_name": "test_relevance",
          "score": 0.0
        },
        {
          "signal_name": "changed_boost",
          "score": 0.0
        }
      ]
    },
    {
      "path": "agent-accel/accel/query/context_compiler.py",
      "score": 0.2,
      "reasons": [
        "test_relevance"
      ],
      "signals": [
        {
          "signal_name": "symbol_match",
          "score": 0.0
        },
        {
          "signal_name": "reference_proximity",
          "score": 0.0
        },
        {
          "signal_name": "dependency_impact",
          "score": 0.0
        },
        {
          "signal_name": "test_relevance",
          "score": 1.0
        },
        {
          "signal_name": "changed_boost",
          "score": 0.0
        }
      ]
    }
  ],
  "snippets": [
    {
      "path": "src/frontend/src/app/components/HarborPilotTerminalRenderer.tsx",
      "start_line": 1,
      "end_line": 52,
      "symbol": "HPToken",
      "reason": "symbol_or_token_focus",
      "content": "import { useEffect, useMemo, useRef, useState, type ReactNode } from 'react';\n\n/**\n * HarborPilot terminal smart renderer\n * - Incremental parsing (streaming chunks)\n * - Detects run headers, bracketed tags ([cmd],[director],[exit]), JSON blocks\n * - Groups into Run cards\n */\n\n/* ----------------------------- Types ----------------------------- */\n\nexport type HPToken =\n  | { kind: 'meta'; text: string }\n  | { kind: 'run_header'; raw: string; ts?: string; iteration?: number; phase?: string }\n  | { kind: 'tag_line'; tag: string; text: string; raw: string }\n  | { kind: 'json'; raw: string; parsed?: unknown; open: boolean; error?: string }\n  | { kind: 'text'; text: string }\n  | { kind: 'blank' };\n\nexport type HPRun = {\n  header: Extract<HPToken, { kind: 'run_header' }>;\n  entries: HPToken[];\n  exitCode?: number;\n};\n\ntype JsonScanState = {\n  open: boolean;\n  depth: number; // brace depth\n  inString: boolean;\n  escape: boolean;\n  buf: string[];\n};\n\nexport type HPParserState = {\n  // carry-over for partial line boundary across chunks\n  carry: string;\n  // currently scanning a JSON block\n  json: JsonScanState;\n  // optional: last meta captured (like leading \"JSON\")\n  metaEmitted: boolean;\n};\n\n/* ----------------------------- Helpers ----------------------------- */\n\nconst RUN_HEADER_RE =\n  /^##\\s+(\\d{4}-\\d{2}-\\d{2}\\s+\\d{2}:\\d{2}:\\d{2})\\s+\\(iteration\\s+(\\d+)\\)\\s+-\\s+(.*)\\s*$/;\nconst RUN_HEADER_RE_ALT = /^##\\s+Run\\s+(\\d+)\\s+-\\s+(.+)\\s*$/;\n\nconst TAG_LINE_RE = /^\\[([a-zA-Z0-9_-]+)\\]\\s*(.*)$/;\n\nfunction safeJsonParse(raw: string): { value?: unknown; error?: string } {\n  try {"
    },
    {
      "path": "src/backend/app/utils.py",
      "start_line": 1,
      "end_line": 60,
      "symbol": "enforce_utf8",
      "reason": "symbol_or_token_focus",
      "content": "import os\nimport sys\nimport json\nimport hashlib\nimport shutil\nfrom datetime import datetime, timezone\nfrom typing import List, Dict, Any, Optional, Tuple\nfrom fastapi import HTTPException\nfrom .config import (\n    Settings,\n    ARTIFACT_ROOT,\n    ARTIFACT_NAMESPACE,\n    LEGACY_ARTIFACT_ROOT,\n    LEGACY_ARTIFACT_NAMESPACE,\n    STATE_TO_RAMDISK_ENV,\n    LOOP_MODULE_DIR,\n    WORKSPACE_STATUS_REL\n)\n\ndef enforce_utf8() -> None:\n    os.environ.setdefault(\"PYTHONUTF8\", \"1\")\n    os.environ.setdefault(\"PYTHONIOENCODING\", \"utf-8\")\n    os.environ.setdefault(\"LANG\", \"en_US.UTF-8\")\n    os.environ.setdefault(\"LC_ALL\", \"en_US.UTF-8\")\n    try:\n        sys.stdout.reconfigure(encoding=\"utf-8\")\n    except Exception:\n        pass\n    try:\n        sys.stderr.reconfigure(encoding=\"utf-8\")\n    except Exception:\n        pass\n\ndef build_utf8_env(extra: Optional[Dict[str, str]] = None) -> Dict[str, str]:\n    env = os.environ.copy()\n    env.setdefault(\"PYTHONUTF8\", \"1\")\n    env.setdefault(\"PYTHONIOENCODING\", \"utf-8\")\n    env.setdefault(\"LANG\", \"en_US.UTF-8\")\n    env.setdefault(\"LC_ALL\", \"en_US.UTF-8\")\n    if extra:\n        env.update(extra)\n    return env\n\ndef ensure_loop_modules() -> None:\n    if os.path.isdir(LOOP_MODULE_DIR) and LOOP_MODULE_DIR not in sys.path:\n        sys.path.insert(0, LOOP_MODULE_DIR)\n\ndef normalize_ramdisk_root(value: str) -> str:\n    raw = (value or \"\").strip()\n    if not raw:\n        return \"\"\n    if not os.path.isabs(raw):\n        return \"\"\n    if len(raw) == 2 and raw[1] == \":\":\n        raw = raw + \"\\\\\"\n    raw = os.path.abspath(raw)\n    raw = raw.rstrip(\"\\\\/\")\n    if len(raw) == 2 and raw[1] == \":\":\n        raw = raw + \"\\\\\"\n    return raw"
    },
    {
      "path": "src/backend/core/harborpilot_loop/director_exec.py",
      "start_line": 1,
      "end_line": 68,
      "symbol": "_enforce_utf8",
      "reason": "symbol_or_token_focus",
      "content": "import difflib\nimport json\nimport os\nimport shlex\nimport subprocess\nimport sys\nimport time\nfrom typing import Any, Dict, List, Optional\n\nfrom io_utils import emit_event, ensure_parent_dir, write_text_atomic\nfrom prompts import (\n    apply_file_blocks,\n    build_file_context,\n    build_ollama_prompt,\n    build_qa_prompt,\n    build_reviewer_prompt,\n    parse_file_blocks,\n)\nfrom shared import FILE_BLOCK_RE, normalize_path, strip_ansi\nfrom ollama_utils import invoke_ollama\nfrom usage import UsageContext\n\n\nPROJECT_ROOT = os.path.abspath(os.path.join(os.path.dirname(__file__), \"..\", \"..\"))\nAPP_ROOT = os.path.abspath(os.path.join(os.path.dirname(__file__), \"..\", \"..\", \"..\", \"..\"))\n\n\ndef _enforce_utf8() -> None:\n    os.environ.setdefault(\"PYTHONUTF8\", \"1\")\n    os.environ.setdefault(\"PYTHONIOENCODING\", \"utf-8\")\n    os.environ.setdefault(\"LANG\", \"en_US.UTF-8\")\n    os.environ.setdefault(\"LC_ALL\", \"en_US.UTF-8\")\n    try:\n        sys.stdout.reconfigure(encoding=\"utf-8\")\n    except Exception:\n        pass\n    try:\n        sys.stderr.reconfigure(encoding=\"utf-8\")\n    except Exception:\n        pass\n\n\ndef _build_utf8_env() -> Dict[str, str]:\n    env = os.environ.copy()\n    env.setdefault(\"PYTHONUTF8\", \"1\")\n    env.setdefault(\"PYTHONIOENCODING\", \"utf-8\")\n    env.setdefault(\"LANG\", \"en_US.UTF-8\")\n    env.setdefault(\"LC_ALL\", \"en_US.UTF-8\")\n    return env\n\n\n_enforce_utf8()\n\n\ndef _build_refs(\n    state: Any,\n    phase: str,\n    files: Optional[List[str]] = None,\n    evidence_path: Optional[str] = None,\n    trajectory_path: Optional[str] = None,\n) -> Dict[str, Any]:\n    refs = {\n        \"task_id\": getattr(state, \"current_task_id\", \"\") or None,\n        \"task_fingerprint\": getattr(state, \"current_task_fingerprint\", \"\") or None,\n        \"run_id\": getattr(state, \"current_run_id\", \"\") or None,\n        \"pm_iteration\": getattr(state, \"current_pm_iteration\", None),\n        \"director_iteration\": getattr(state, \"current_director_iteration\", None),\n        \"phase\": phase,"
    },
    {
      "path": "tests/e2e/utils/file_utils.py",
      "start_line": 1,
      "end_line": 53,
      "symbol": "FileUtils",
      "reason": "symbol_or_token_focus",
      "content": "\"\"\"\nFile utilities for HarborPilot E2E tests\n\"\"\"\n\nimport shutil\nimport json\nimport tempfile\nfrom pathlib import Path\nfrom typing import Dict, Any, List, Union\nfrom loguru import logger\n\n\nclass FileUtils:\n    \"\"\"Utility class for file operations\"\"\"\n    \n    @staticmethod\n    def ensure_directory(path: Union[str, Path]) -> Path:\n        \"\"\"\n        Ensure directory exists, create if it doesn't\n        \n        Args:\n            path: Directory path\n            \n        Returns:\n            Path object\n        \"\"\"\n        path_obj = Path(path)\n        path_obj.mkdir(parents=True, exist_ok=True)\n        return path_obj\n    \n    @staticmethod\n    def create_file(path: Union[str, Path], content: str = \"\", encoding: str = \"utf-8\") -> Path:\n        \"\"\"\n        Create file with content\n        \n        Args:\n            path: File path\n            content: File content\n            encoding: File encoding\n            \n        Returns:\n            Path object\n        \"\"\"\n        path_obj = Path(path)\n        FileUtils.ensure_directory(path_obj.parent)\n        \n        with open(path_obj, 'w', encoding=encoding) as f:\n            f.write(content)\n        \n        logger.debug(f\"Created file: {path_obj}\")\n        return path_obj\n    \n    @staticmethod"
    },
    {
      "path": "src/frontend/src/app/components/llm/state/ProviderContext.tsx",
      "start_line": 5,
      "end_line": 85,
      "symbol": "restoreProviderTestStatus",
      "reason": "symbol_or_token_focus",
      "content": "\nimport React, { createContext, useContext, useReducer, useCallback, useMemo, useEffect } from 'react';\nimport type { ReactNode } from 'react';\nimport type {\n  ProviderState,\n  ProviderAction,\n  ConnectivityResultStrict,\n  TestStatus,\n  ConnectivityStatus,\n} from './providerReducer';\nimport type { RoleIdStrict, InterviewSuiteReportStrict } from '../types/strict';\nimport {\n  providerReducer,\n  initialProviderState,\n  ProviderActions\n} from './providerReducer';\nimport type { ProviderConfig, UnifiedLlmConfig } from '../types';\n\n// ============================================================================\n// Persistence Constants\n// ============================================================================\n\nconst STORAGE_KEYS = {\n  PROVIDER_TEST_STATUS: 'llm_provider_test_status',\n  CONNECTIVITY_RESULTS: 'llm_connectivity_results',\n} as const;\n\nconst PROVIDER_STATUS_TTL_MS = 24 * 60 * 60 * 1000; // 24 hours\nconst CONNECTIVITY_TTL_MS = 5 * 60 * 1000; // 5 minutes\n\ninterface PersistedProviderStatus {\n  status: 'success' | 'failed';\n  timestamp: number;\n  model?: string;\n}\n\n// ============================================================================\n// Persistence Utilities\n// ============================================================================\n\nfunction restoreProviderTestStatus(): Record<string, ConnectivityStatus> {\n  if (typeof window === 'undefined') return {};\n\n  try {\n    const stored = localStorage.getItem(STORAGE_KEYS.PROVIDER_TEST_STATUS);\n    if (!stored) return {};\n\n    const parsed: Record<string, PersistedProviderStatus> = JSON.parse(stored);\n    const now = Date.now();\n    const restored: Record<string, ConnectivityStatus> = {};\n\n    Object.entries(parsed).forEach(([providerId, data]) => {\n      if (now - data.timestamp <= PROVIDER_STATUS_TTL_MS) {\n        restored[providerId] = data.status;\n      }\n    });\n\n    return restored;\n  } catch {\n    return {};\n  }\n}\n\nfunction restoreConnectivityResults(): Map<string, ConnectivityResultStrict> {\n  if (typeof window === 'undefined') return new Map();\n\n  try {\n    const stored = localStorage.getItem(STORAGE_KEYS.CONNECTIVITY_RESULTS);\n    if (!stored) return new Map();\n\n    const parsed: Record<string, ConnectivityResultStrict> = JSON.parse(stored);\n    const now = Date.now();\n    const restored = new Map<string, ConnectivityResultStrict>();\n\n    Object.entries(parsed).forEach(([key, result]) => {\n      const timestamp = new Date(result.timestamp).getTime();\n      if (now - timestamp <= CONNECTIVITY_TTL_MS) {\n        restored.set(key, result);\n      }\n    });\n"
    },
    {
      "path": "src/frontend/src/app/components/llm/providers/AnthropicCompatProviderSettings.tsx",
      "start_line": 1,
      "end_line": 55,
      "symbol": "AnthropicCompatProviderSettings",
      "reason": "symbol_or_token_focus",
      "content": "import React, { useEffect, useState } from 'react';\nimport { BaseProviderSettings } from './BaseProviderSettings';\nimport { type ProviderConfig, type ProviderValidateFn } from '../types';\n\nconst cyberInputClasses = \"flex h-9 w-full min-w-0 rounded-md border border-white/10 bg-black/40 px-3 py-1 text-sm text-slate-100 placeholder:text-slate-500 transition-all duration-200 outline-none focus:border-violet-500/50 focus:ring-2 focus:ring-violet-500/20 focus:bg-black/60 hover:border-violet-400/30 hover:bg-black/50 disabled:opacity-50 disabled:cursor-not-allowed\";\n\nconst cyberTextareaClasses = \"w-full min-w-0 rounded-md border border-white/10 bg-black/40 px-3 py-2 text-sm text-slate-100 placeholder:text-slate-500 transition-all duration-200 outline-none focus:border-violet-500/50 focus:ring-2 focus:ring-violet-500/20 focus:bg-black/60 hover:border-violet-400/30 hover:bg-black/50 disabled:opacity-50 disabled:cursor-not-allowed font-mono h-16\";\n\ninterface AnthropicCompatProviderSettingsProps {\n  provider: ProviderConfig;\n  onUpdate: (updates: Partial<ProviderConfig>) => void;\n  onValidate: ProviderValidateFn;\n}\n\nexport function AnthropicCompatProviderSettings({\n  provider,\n  onUpdate,\n  onValidate\n}: AnthropicCompatProviderSettingsProps) {\n  const handleFieldChange = (field: string, value: any) => {\n    onUpdate({ [field]: value });\n  };\n  const serializedHeaders = JSON.stringify(provider.headers || {}, null, 2);\n  const [headersText, setHeadersText] = useState(serializedHeaders);\n  const anthropicVersion =\n    typeof provider.anthropic_version === 'string' && provider.anthropic_version.trim() !== ''\n      ? provider.anthropic_version\n      : '2023-06-01';\n  const modelId =\n    typeof provider.model === 'string' && provider.model.trim() !== ''\n      ? provider.model\n      : typeof provider.default_model === 'string'\n        ? provider.default_model\n        : '';\n\n  useEffect(() => {\n    setHeadersText(serializedHeaders);\n  }, [serializedHeaders]);\n\n  return (\n    <BaseProviderSettings provider={provider} onUpdate={onUpdate} onValidate={onValidate}>\n      {/* Anthropic Compatible Specific Settings */}\n      <div className=\"space-y-3\">\n        <h5 className=\"text-xs font-semibold text-text-main\">Anthropic Compatible Configuration</h5>\n        \n        {/* API Path */}\n        <div>\n          <label className=\"block text-xs text-text-muted mb-1\">API Path</label>\n          <input\n            type=\"text\"\n            value={provider.api_path || '/v1/messages'}\n            onChange={(e) => handleFieldChange('api_path', e.target.value)}\n            placeholder=\"/v1/messages\"\n            className={cyberInputClasses}\n          />"
    },
    {
      "path": "src/frontend/src/app/components/llm/providers/CodexCLIProviderSettings.tsx",
      "start_line": 1,
      "end_line": 57,
      "symbol": "CodexCLIProviderSettings",
      "reason": "symbol_or_token_focus",
      "content": "import React from 'react';\nimport { BaseProviderSettings } from './BaseProviderSettings';\nimport { CodexModelBrowser } from '../model-browser/CodexModelBrowser';\nimport { CLI_MODES, type CLIMode, type ProviderConfig, type ProviderValidateFn } from '../types';\nimport type { CodexExecConfig } from '../types/strict';\n\nconst cyberInputClasses = \"flex h-9 w-full min-w-0 rounded-md border border-white/10 bg-black/40 px-3 py-1 text-sm text-slate-100 placeholder:text-slate-500 transition-all duration-200 outline-none focus:border-violet-500/50 focus:ring-2 focus:ring-violet-500/20 focus:bg-black/60 hover:border-violet-400/30 hover:bg-black/50 disabled:opacity-50 disabled:cursor-not-allowed\";\nconst cyberSelectClasses = \"flex h-9 w-full min-w-0 rounded-md border border-white/10 bg-black/40 px-3 py-1 text-sm text-slate-100 transition-all duration-200 outline-none focus:border-violet-500/50 focus:ring-2 focus:ring-violet-500/20 focus:bg-black/60 hover:border-violet-400/30 hover:bg-black/50 cursor-pointer appearance-none bg-[url('data:image/svg+xml;charset=utf-8,%3Csvg%20xmlns%3D%22http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg%22%20width%3D%2224%22%20height%3D%2224%22%20viewBox%3D%220%200%2024%2024%22%20fill%3D%22none%22%20stroke%3D%22%2394a3b8%22%20stroke-width%3D%222%22%20stroke-linecap%3D%22round%22%20stroke-linejoin%3D%22round%22%3E%3Cpolyline%20points%3D%226%209%2012%2015%2018%209%22%3E%3C%2Fpolyline%3E%3C%2Fsvg%3E')] bg-[length:16px] bg-[right_8px_center] bg-no-repeat pr-10\";\n\ninterface CodexCLIProviderSettingsProps {\n  providerId?: string;\n  provider: ProviderConfig;\n  onUpdate: (updates: Partial<ProviderConfig>) => void;\n  onValidate: ProviderValidateFn;\n}\n\nexport function CodexCLIProviderSettings({\n  providerId,\n  provider,\n  onUpdate,\n  onValidate\n}: CodexCLIProviderSettingsProps) {\n  const handleFieldChange = (field: string, value: any) => {\n    onUpdate({ [field]: value });\n  };\n\n  const codexExec = (provider.codex_exec || {}) as CodexExecConfig & Record<string, unknown>;\n  const codexExecColor = (codexExec.color || 'never') as 'never' | 'auto' | 'always';\n  const codexExecSandbox = (codexExec.sandbox || 'read-only') as 'read-only' | 'workspace-write' | 'danger-full-access';\n  const codexExecProfile = (codexExec.profile || '') as string;\n  const codexExecConfig = (codexExec.config || []) as string[];\n  const codexExecAddDirs = (codexExec.add_dirs || []) as string[];\n  const codexExecOutputSchema = (codexExec.output_schema || '') as string;\n  const codexExecOutputLastMessage = (codexExec.output_last_message || '') as string;\n  const modelId = typeof provider.model === 'string' ? provider.model : '';\n  const codexExecConfigArr = Array.isArray(codexExecConfig) ? codexExecConfig : [];\n  const cliMode: CLIMode =\n    provider.cli_mode === CLI_MODES.TUI || provider.cli_mode === CLI_MODES.HEADLESS\n      ? provider.cli_mode\n      : CLI_MODES.HEADLESS;\n\n  const getConfigOverrideValue = (key: string): string | null => {\n    for (const entry of codexExecConfigArr) {\n      const eqIndex = entry.indexOf('=');\n      if (eqIndex <= 0) {\n        continue;\n      }\n      const entryKey = entry.slice(0, eqIndex).trim();\n      if (entryKey !== key) {\n        continue;\n      }\n      const rawValue = entry.slice(eqIndex + 1).trim();\n      if (\n        (rawValue.startsWith('\"') && rawValue.endsWith('\"')) ||\n        (rawValue.startsWith(\"'\") && rawValue.endsWith(\"'\"))\n      ) {\n        return rawValue.slice(1, -1);"
    },
    {
      "path": "src/frontend/src/app/components/llm/providers/GeminiCLIProviderSettings.tsx",
      "start_line": 1,
      "end_line": 55,
      "symbol": "GeminiCLIProviderSettings",
      "reason": "symbol_or_token_focus",
      "content": "import React from 'react';\nimport { BaseProviderSettings } from './BaseProviderSettings';\nimport { CLI_MODES, type CLIMode, type ProviderConfig, type ProviderValidateFn } from '../types';\n\nconst cyberInputClasses = \"flex h-9 w-full min-w-0 rounded-md border border-white/10 bg-black/40 px-3 py-1 text-sm text-slate-100 placeholder:text-slate-500 transition-all duration-200 outline-none focus:border-violet-500/50 focus:ring-2 focus:ring-violet-500/20 focus:bg-black/60 hover:border-violet-400/30 hover:bg-black/50 disabled:opacity-50 disabled:cursor-not-allowed\";\nconst cyberSelectClasses = \"flex h-9 w-full min-w-0 rounded-md border border-white/10 bg-black/40 px-3 py-1 text-sm text-slate-100 transition-all duration-200 outline-none focus:border-violet-500/50 focus:ring-2 focus:ring-violet-500/20 focus:bg-black/60 hover:border-violet-400/30 hover:bg-black/50 cursor-pointer appearance-none bg-[url('data:image/svg+xml;charset=utf-8,%3Csvg%20xmlns%3D%22http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg%22%20width%3D%2224%22%20height%3D%2224%22%20viewBox%3D%220%200%2024%2024%22%20fill%3D%22none%22%20stroke%3D%22%2394a3b8%22%20stroke-width%3D%222%22%20stroke-linecap%3D%22round%22%20stroke-linejoin%3D%22round%22%3E%3Cpolyline%20points%3D%226%209%2012%2015%2018%209%22%3E%3C%2Fpolyline%3E%3C%2Fsvg%3E')] bg-[length:16px] bg-[right_8px_center] bg-no-repeat pr-10\";\nconst cyberTextareaClasses = \"flex w-full min-w-0 rounded-md border border-white/10 bg-black/40 px-3 py-2 text-sm text-slate-100 placeholder:text-slate-500 transition-all duration-200 outline-none focus:border-violet-500/50 focus:ring-2 focus:ring-violet-500/20 focus:bg-black/60 hover:border-violet-400/30 hover:bg-black/50 disabled:opacity-50 disabled:cursor-not-allowed min-h-[80px] resize-y\";\n\ninterface GeminiCLIProviderSettingsProps {\n  provider: ProviderConfig;\n  onUpdate: (updates: Partial<ProviderConfig>) => void;\n  onValidate: ProviderValidateFn;\n}\n\nexport function GeminiCLIProviderSettings({\n  provider,\n  onUpdate,\n  onValidate\n}: GeminiCLIProviderSettingsProps) {\n  const handleFieldChange = (field: string, value: any) => {\n    onUpdate({ [field]: value });\n  };\n\n  const geminiProvider = provider as ProviderConfig & { health_args?: string[]; list_args?: string[] };\n  const env = provider.env || {};\n  const cliMode: CLIMode =\n    provider.cli_mode === CLI_MODES.TUI || provider.cli_mode === CLI_MODES.HEADLESS\n      ? provider.cli_mode\n      : CLI_MODES.HEADLESS;\n  const headlessArgs = Array.isArray(provider.args) && provider.args.length\n    ? provider.args\n    : ['chat', '--model', '{model}', '--prompt', '{prompt}'];\n  const headlessTemplate = [provider.command || 'gemini', ...headlessArgs].join(' ');\n  const missingModelPlaceholder = !headlessTemplate.includes('{model}');\n  const missingPromptPlaceholder = !headlessTemplate.includes('{prompt}');\n\n  return (\n    <BaseProviderSettings provider={provider} onUpdate={onUpdate} onValidate={onValidate}>\n      {/* Gemini CLI Specific Settings */}\n      <div className=\"space-y-3\">\n        <h5 className=\"text-xs font-semibold text-text-main\">Gemini CLI Configuration</h5>\n\n        {/* CLI Mode */}\n        <div>\n          <label className=\"block text-xs text-text-muted mb-1\">CLI Mode</label>\n          <select\n            value={cliMode}\n            onChange={(e) => handleFieldChange('cli_mode', e.target.value)}\n            className=\"w-full bg-black/30 text-text-main px-3 py-2 rounded border border-white/10 text-sm\"\n          >\n            <option value={CLI_MODES.HEADLESS}>Headless (non-interactive)</option>\n            <option value={CLI_MODES.TUI}>TUI (interactive)</option>\n          </select>\n          <p className=\"text-[9px] text-text-dim mt-1\">\n            Headless mode is recommended for automation and testing."
    },
    {
      "path": "src/frontend/src/app/components/llm/providers/OllamaProviderSettings.tsx",
      "start_line": 1,
      "end_line": 55,
      "symbol": "OllamaProviderSettings",
      "reason": "symbol_or_token_focus",
      "content": "import React, { useState, useEffect } from 'react';\nimport { BaseProviderSettings } from './BaseProviderSettings';\nimport { type ProviderConfig, type ProviderValidateFn } from '../types';\nimport { Loader2, RefreshCw, Check, AlertCircle } from 'lucide-react';\n\ninterface OllamaProviderSettingsProps {\n  provider: ProviderConfig;\n  onUpdate: (updates: Partial<ProviderConfig>) => void;\n  onValidate: ProviderValidateFn;\n}\n\nconst cyberInputClasses = \"flex h-9 w-full min-w-0 rounded-md border border-white/10 bg-black/40 px-3 py-1 text-sm text-slate-100 placeholder:text-slate-500 transition-all duration-200 outline-none focus:border-violet-500/50 focus:ring-2 focus:ring-violet-500/20 focus:bg-black/60 hover:border-violet-400/30 hover:bg-black/50 disabled:opacity-50 disabled:cursor-not-allowed\";\nconst cyberSelectClasses = \"flex h-9 w-full min-w-0 rounded-md border border-white/10 bg-black/40 px-3 py-1 text-sm text-slate-100 transition-all duration-200 outline-none focus:border-violet-500/50 focus:ring-2 focus:ring-violet-500/20 focus:bg-black/60 hover:border-violet-400/30 hover:bg-black/50 cursor-pointer appearance-none bg-[url('data:image/svg+xml;charset=utf-8,%3Csvg%20xmlns%3D%22http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg%22%20width%3D%2224%22%20height%3D%2224%22%20viewBox%3D%220%200%2024%2024%22%20fill%3D%22none%22%20stroke%3D%22%2394a3b8%22%20stroke-width%3D%222%22%20stroke-linecap%3D%22round%22%20stroke-linejoin%3D%22round%22%3E%3Cpolyline%20points%3D%226%209%2012%2015%2018%209%22%3E%3C%2Fpolyline%3E%3C%2Fsvg%3E')] bg-[length:16px] bg-[right_8px_center] bg-no-repeat pr-10\";\n\nexport function OllamaProviderSettings({\n  provider,\n  onUpdate,\n  onValidate\n}: OllamaProviderSettingsProps) {\n  const [availableModels, setAvailableModels] = useState<string[]>([]);\n  const [isLoadingModels, setIsLoadingModels] = useState(false);\n  const [modelError, setModelError] = useState<string | null>(null);\n  const [isCustomModel, setIsCustomModel] = useState(false);\n  \n  const ollamaProvider = provider as ProviderConfig & { gpu_layers?: number; context_size?: number };\n\n  const handleFieldChange = (field: string, value: any) => {\n    onUpdate({ [field]: value });\n  };\n\n  const fetchModels = async () => {\n    setIsLoadingModels(true);\n    setModelError(null);\n    const baseUrl = provider.base_url || 'http://127.0.0.1:11434';\n    \n    try {\n      // Clean up base URL to ensure valid fetch\n      const url = new URL('/api/tags', baseUrl).toString();\n      const response = await fetch(url);\n      \n      if (!response.ok) {\n        throw new Error(`Failed to connect: ${response.statusText}`);\n      }\n      \n      const data = await response.json();\n      const models = (data.models || []).map((m: any) => m.name);\n      setAvailableModels(models);\n      \n      // If current model is not in list and not empty, set as custom\n      if (provider.model && !models.includes(provider.model)) {\n        setIsCustomModel(true);\n      }\n    } catch (error) {\n      console.error('Failed to fetch Ollama models:', error);\n      setModelError(error instanceof Error ? error.message : 'Failed to fetch models');"
    },
    {
      "path": "agent-accel/accel/query/context_compiler.py",
      "start_line": 1,
      "end_line": 55,
      "symbol": "_group_by_file",
      "reason": "symbol_or_token_focus",
      "content": "from __future__ import annotations\n\nimport json\nfrom datetime import datetime, timezone\nfrom pathlib import Path\nfrom typing import Any\n\nfrom .planner import build_candidate_files, normalize_task_tokens\nfrom .ranker import score_file\nfrom .snippet_extractor import extract_snippet\nfrom ..storage.cache import project_paths\nfrom ..storage.index_cache import load_index_rows\n\n\ndef _group_by_file(rows: list[dict[str, Any]], key: str) -> dict[str, list[dict[str, Any]]]:\n    grouped: dict[str, list[dict[str, Any]]] = {}\n    for row in rows:\n        file_value = str(row.get(key, \"\"))\n        if not file_value:\n            continue\n        grouped.setdefault(file_value, []).append(row)\n    return grouped\n\n\ndef _build_verify_plan(\n    top_files: list[dict[str, Any]],\n    test_ownership_rows: list[dict[str, Any]],\n    changed_files: list[str],\n) -> dict[str, list[str]]:\n    selected_files = {item[\"path\"] for item in top_files}\n    target_tests: list[str] = []\n    seen_tests: set[str] = set()\n    for row in test_ownership_rows:\n        owns = str(row.get(\"owns_file\", \"\"))\n        test_file = str(row.get(\"test_file\", \"\"))\n        if owns in selected_files and test_file and test_file not in seen_tests:\n            seen_tests.add(test_file)\n            target_tests.append(test_file)\n\n    changed = [item.lower() for item in changed_files]\n    checks: list[str] = []\n    if not changed or any(item.endswith(\".py\") for item in changed):\n        checks.append(\"pytest -q\")\n        checks.append(\"mypy .\")\n    if not changed or any(item.endswith((\".ts\", \".tsx\", \".js\", \".jsx\")) for item in changed):\n        checks.append(\"npm run typecheck\")\n    return {\"target_tests\": target_tests[:20], \"target_checks\": checks}\n\n\ndef compile_context_pack(\n    project_dir: Path,\n    config: dict[str, Any],\n    task: str,\n    changed_files: list[str] | None = None,\n    hints: list[str] | None = None,"
    }
  ],
  "verify_plan": {
    "target_tests": [
      "agent-accel/tests/unit/test_index_and_context.py",
      "src/backend/tests/test_context_engine.py",
      "tests/test_plan_act_context.py",
      "src/backend/tests/test_codex_cli_utils.py",
      "tests/test_codex_utils.py",
      "tests/test_decision_utils.py",
      "tests/test_director_exec_utils.py",
      "tests/test_io_utils_core.py",
      "tests/test_io_utils_jsonl.py",
      "tests/test_loop_pm_utils.py",
      "tests/test_ollama_utils.py",
      "tests/test_shared_utils.py",
      "src/backend/tests/test_director_logic.py",
      "tests/functional/test_director_flow.py",
      "tests/test_director_evidence_trajectory.py",
      "tests/test_director_policy_runtime.py",
      "tests/test_director_result_matcher.py",
      "tests/test_director_stop.py",
      "tests/test_director_tooling.py",
      "tests/test_loop_director_required_evidence.py"
    ],
    "target_checks": [
      "pytest -q",
      "mypy .",
      "npm run typecheck"
    ]
  },
  "meta": {
    "task_tokens": [
      "refactor",
      "major",
      "harborpilot",
      "hotspots",
      "minimal",
      "behavior",
      "change"
    ],
    "changed_files": [],
    "drift_reason": ""
  }
}
